<IfDefine MOONSPEAK_DEV_MODE>
# config used when running in dev mode without docker
# on mac remember to brew install apache2
LoadModule mpm_event_module lib/httpd/modules/mod_mpm_event.so
LoadModule info_module lib/httpd/modules/mod_info.so
LoadModule unixd_module lib/httpd/modules/mod_unixd.so
LoadModule authn_core_module lib/httpd/modules/mod_authn_core.so
LoadModule authz_core_module lib/httpd/modules/mod_authz_core.so
LoadModule mime_module lib/httpd/modules/mod_mime.so
LoadModule log_config_module lib/httpd/modules/mod_log_config.so
LoadModule env_module lib/httpd/modules/mod_env.so
LoadModule setenvif_module lib/httpd/modules/mod_setenvif.so
LoadModule dir_module lib/httpd/modules/mod_dir.so
LoadModule alias_module lib/httpd/modules/mod_alias.so
# pip install mod_wsgi && mod_wsgi-express module-location
LoadModule wsgi_module "/usr/local/lib/python3.11/site-packages/mod_wsgi/server/mod_wsgi-py311.cpython-311-darwin.so"
Listen 8041
ServerName u-demosuer1-s-graph.moonspeak.com
</IfDefine>

<IfDefine MOONSPEAK_DOCKER_MODE>
# load inside docker
LoadModule mpm_event_module     /usr/lib/apache2/modules/mod_mpm_event.so
LoadModule info_module          /usr/lib/apache2/modules/mod_info.so
LoadModule authn_core_module    /usr/lib/apache2/modules/mod_authn_core.so
LoadModule authz_core_module    /usr/lib/apache2/modules/mod_authz_core.so
LoadModule mime_module          /usr/lib/apache2/modules/mod_mime.so
LoadModule dir_module           /usr/lib/apache2/modules/mod_dir.so
LoadModule alias_module         /usr/lib/apache2/modules/mod_alias.so

LoadModule wsgi_module          /usr/lib/apache2/modules/mod_wsgi.so
LoadModule auth_openidc_module  /usr/lib/apache2/modules/mod_auth_openidc.so
LoadModule authz_user_module    /usr/lib/apache2/modules/mod_authz_user.so



TypesConfig /etc/mime.types
User www-data
Group www-data
Listen 80
ServerName u-${MOONSPEAK_USER}-s-graph.moonspeaknet

OIDCProviderMetadataURL "${MOONSPEAK_KEYCLOAK_BACKEND_URL}/realms/moonspeak/.well-known/openid-configuration"
OIDCClientID graph
OIDCClientSecret ${GRAPH_CLIENT_SECRET}
# used privately by mod_auth_openidc, choose a strong passphrase, see: https://github.com/OpenIDC/mod_auth_openidc/discussions/575
OIDCCryptoPassphrase ${MOONSPEAK_OIDC_CRYPTO_PASSPHRASE}
# OIDCRedirectURI is a vanity URL that must point to a path protected by this module but must NOT point to any content
# it should be registered as the Redirect or Callback URI with your client at the Provider
OIDCRedirectURI /oauth2callback
# maps the preferred_username claim to the REMOTE_USER environment variable
OIDCRemoteUserClaim email
OIDCScope "openid email"
OIDCSessionType "client-cookie:persistent:store_id_token"
# to test this error page, set invalid client credentials for graph, then it will appear every time
OIDCHTMLErrorTemplate "../frontend/apache_oidc_htlm_error_template.html"


<Location /oauth2callback>
    Redirect 301 "/oauth2callback" "/"
</Location>

<Location />
    AuthType openid-connect
    Require valid-user
</Location>

</IfDefine>

LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %b" common
# LogLevel info
LogLevel info auth_openidc_module:debug
ErrorLog /dev/stderr
CustomLog /dev/stdout combined

# security config see: https://httpd.apache.org/docs/2.4/en/misc/security_tips.html
# it is not recommended to throw away default apache config
LimitRequestBody 102400
ServerSignature Off
<Directory />
    Require all denied
</Directory>

# config url paths
ServerRoot "."

DocumentRoot "../frontend/src/main/webapp"
<Directory "../frontend/src/main/webapp">
    Require all granted
</Directory>

Alias "/config" "../config"
<Directory "../config">
    Require all granted
</Directory>

WSGIScriptAlias "/api/" "apache.wsgi/api/"
<Files "./apache.wsgi">
    Require all granted
</Files>

# enforce mod_wsgi daemon mode
WSGIDaemonProcess moonspeak threads=1
WSGIProcessGroup moonspeak
WSGIApplicationGroup %{GLOBAL}
WSGIRestrictEmbedded On

# tune event mpm see https://httpd.apache.org/docs/2.4/mod/mpm_common.html
ServerLimit 1
ThreadLimit 3
StartServers 1
MaxRequestWorkers 3
MinSpareThreads 1
MaxSpareThreads 2
ThreadsPerChild 3
# see https://httpd.apache.org/docs/2.4/mod/mpm_common.html#threadstacksize
ThreadStackSize 204800
