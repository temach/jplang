Magic link provider for keycloak is PhaseTwo or DasNico example

# PhaseTwo
source code: https://github.com/p2-inc/keycloak-magic-link
instructions: https://phasetwo.io/blog/set-up-magic-links/ 
testing: https://github.com/tstec-polypoly/explore-keycloak and https://github.com/tstec-polypoly/explore-keycloak/blob/main/00_keycloak_generate_magic_link.ipynb

# DasNico
source code: https://github.com/dasniko/keycloak-extensions-demo/tree/main/magiclink
instructions: https://www.youtube.com/watch?v=2xN3KOK5Je0


# Useful links
Keycloak spi to listen for user events such as registration and to send a welcome email:
https://github.com/p2-inc/keycloak-events#user-change-listener

Configuration as code for keycloak (somewhere between raw realm json and terraform):
https://github.com/adorsys/keycloak-config-cli/

List of standard claims that services get about the user (sub, email, preferred_username,  picture):
https://openid.net/specs/openid-connect-core-1_0.html#StandardClaims


Example token with claims that gets returned to a microservice from our keycloak. Each field is a claim:

https://jwt.io/#debugger-io?token=eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJYMVBDVklFYmlyTHV1S3F4VkdSWTNNd1V2QzBrZENEWHdDRVp5anlrLW13In0.eyJleHAiOjE3MDI3MDk1NzksImlhdCI6MTcwMjcwOTI3OSwiYXV0aF90aW1lIjoxNzAyNzA5Mjc5LCJqdGkiOiI2ZDA1ZDNkYy04NzhmLTQ0MmItYTE0Ni05NjA4MjAyYTQ2MzEiLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0Ojg0NDMvcmVhbG1zL21vb25zcGVhayIsImF1ZCI6ImdyYXBoIiwic3ViIjoiZWU3YjIyNGMtNmI3ZS00ZmJiLTkxOGUtOWUwN2QzMTRmMDlhIiwidHlwIjoiSUQiLCJhenAiOiJncmFwaCIsIm5vbmNlIjoiODRjMGVjMWItZWM5Zi00MGE3LThlODMtZDJlZjNiODgzMWU0Iiwic2Vzc2lvbl9zdGF0ZSI6IjYzYTZlY2EwLTllNmEtNGFhYi04YjY4LWFhNjE2NzEzYTg5YyIsImF0X2hhc2giOiJIa083QzFjaWp1SlZudmRiYjktMmxRIiwiYWNyIjoiMSIsInNpZCI6IjYzYTZlY2EwLTllNmEtNGFhYi04YjY4LWFhNjE2NzEzYTg5YyIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJ3d3dAMjIuY29tIiwiZW1haWwiOiJ3d3dAMjIuY29tIn0.r6_Psm1wZE7D3PAKp1opdCCBeVY2G6e2xtjqzyQijKOlnED7T3wlvHrOj_VGp8z3-rujp7nU0M4Gf51SQNVwLs-_c4UOiwmOX5gpO7Fin17fB33-ekGgdt-lPnEbatnaU6R57tjImAoXunngjGoQpxxrkSj9h9IWD6_lDeTT984VASE_S6AHwsok7QWmy_h49Tu7rfVpOZWNHmuABGTCkUAdr8esDyIoPaa5Q5h7rd3uusooML6tYhCr5TED4to-IsjE00keY5x_1rBmPnIIX-XKBRTRcRtBdojc9EvAjC0ZqWpgKp2BoGfZRqTtUaQbIvXwFxG2KPvDR-oXsaJwfg&publicKey=%7B%0A%20%20%22e%22%3A%20%22AQAB%22%2C%0A%20%20%22kty%22%3A%20%22RSA%22%2C%0A%20%20%22n%22%3A%20%22vDWvWWVD9p8U9zi7nbsEia5dm9UPCcretQtfEPxErdrHp2N9tQ5ydJqb87Maf6tVEsQ7Qq1OXXPhrruNEjBI3Si4V0aYrPY2xeV_uGsxCVjPq6tad8c9vVZybpzDoof8Xh2EkYZ7jiF8-TMLA8-_Qm-BtXp0daFNrJf5zv-NkAcG6gCBE6V7knM-6Jk_0eec9BI_MPavPkoOW6NjCK1TMSzGSfoLO4QgH9c9NX6SVuyFUIFk1VOJqEoXTWFUa4Ii2BGL2Y8LzVLk7HH6U1g7PS3YzJmE-XOvwMVHM4RiEo4n636XKGAKfmzq1wRIWt8r1bDK1n7X3r2kNt4RMxt6dw%22%0A%7D



In case of apache mod_auth_oidc the following session is created and stored in a cookie
This session is encrypted with the oidc passphrase:

Cookie=mod_auth_openidc_session_0=eyJhbGciOiAiZGlyIiwgImVuYyI6ICJBMjU2R0NNIn0..rO3GOLKS8XsWm5Aw.abtbRVqyxkHdtl6sSQinB6qS3Aljlsk2rOiCq68SCgDrrE2VfftEuSMLgr8I9zzgZaCHThcMd2ZNgTeJThxHLk6jH7_eSVdmiAbedV-IWag0PeNYXUUyHtqtAVBLGTumpOhJGL596wzIK0xJliH-bMRWe5qTyPEFT4qJc9OEzTPxiPPKlugklBVpVrAZWA8i1dPMEBawuY1m9DT-unwhTlyyqFgeK7UO2EhTleImd9zvkAaaIP6k0CJBoGk4thQd3_1dHq35cv9FT8tEPP4s3txJLMEXdLbqAHJiXZ-I5pDK9wuoCnBc1PTed4aaMsLEM_eyHHU2uQ5l8kd53dzXL1wRqSh3rilROMr--iRnI4rCosnWP3p8OtT_Wc_sodTKQwsuna5gPFoTm3lh4F9gui_Thm0OOZvbc9VlEjocvU9HmhAzvnXHlypZZhWShvsapigdlsR2jXk6GgTHW5IT93P9eqmOKyMqbqK74SX3pNRHZXLIfZ0LkdsQvNbuC-TimLGkcV9kQNUJkHlrKpjh7GWncnoEfiw2s203EFtK07jXk0kXxgQC2qE-Niot9cZR1R04CpsD3H3ca1p_SUufr3Cq9gQtm6NR3KlMsThwKxZ_sTK2DzH9RoLRTDUTKmueTtQF775JDitof3-cW0fIs_iapn5UkAWeFJEpl4veJtu9UjJHN7a_MwalzsykfzN0gKj_39HoAvbpr5zCHYxfzkMQ_OYVGFJHPnIQB8qf3o1IhgoWa5AwbjsObwJmQQ4IABhfAdtgduWBujBM2K_QS9MMJuF4Npu8CCehe7u48lpi5yznBxyc80gAk4-k7PqtHXyJGTwrX44p_z-w2bjyt-AlXwYFBWn_LLrMHymL30Q9-xTkTB2ySflSDvNOKmY2t35LuFtqriNENN3_jb7QzzKYITfLKa1UTvGRQBr1_VIhwEGyPvlWwUVMfBwONtJg4-nPS54Lk-ouoNDaVtr_ANZ-za2T7QsQScbhhHp0Wid47WMeYw1EShLBlp-betxIYQ3c8WqWx28C9EM4LNTxbhwTjR3B3SODHByUs5R57Gs0haQQVbXGjlxDxx8aLdZgSEuz-Wttqh_hK1LFPhLH7Mdl2qIPuRQxCzCp3o1SOHVUdnQw-MNRdxwb0TBJFN_binQlnsH5tuIBkl7BTZvSVYLKTfEkAHLZHRHC-r9CYNjsA8IK2H0hCgcPteg5uSlaA5gkx1vZid_gcHVLRtmWYIv9pzY1GK-Rlu8xH7M6AJYKbxoP841vyxwJKO-TPgDZ5RbsrJA3LpX9xJsNlQ6eX120_1lfSFNcxPN0vejRE7PYS9I99aLzxba28U4N1yJK8bPuVraYLw-9LHviIF3K5Au45sYzcl7ObWEX_Uug-yZ9qa2dqm4TsLAMEmEdSDwb7w2oWjYzKdujPusWA7EMRSJi9hGvyX_uBanLLFBRIbLkNYcSFIebOHAgVU5P6ES2NSJdscgW0qzr1V89LBegG0nX_D-h7Gv1FA67ewkHimR4CULfT5JdXR1xpIqcos0rbQacA6ewzjiMBkLC3Xmkx0eqiqrTvD4aNbQrITC2m4T2P-2fJpDhu2vwMKObrVzQcKeRgf-97H9jmabIZw5u4NWPrEuwYpuNCDSSmjhyEcLQZrRHG7roUBvojOLf5WB0iT7-MA_0WHaPfeB2bmSw64c8aBqCuWn2J-WSDPFa24zdFtgazrCTQZgaAwA52Wm7oT19wGGkxnOyuEp2M-scIlLgRVYoIUV52H0a8j-u3X_SIAcPSZE6TXwM6834OObAjbkFD5HT_e015bBpEPOzY7WmF0_sfR3Jg3jOwBnJya6W3YM6iQZzIr_lFekT_wfbZCtwdWf1pGMpIFpF-ocZoPGcs01fTRK7-45KU-0AZ5BcnQTThkeVMZxLNEiozwlX_pLzRd5S0ZqaJx64m5ZcXxDs8VT60H1Kwo7QnCBj15reLWE25RnZXRc49UmyJAe3EtfOzFtig7uAeMMDXqepEws1y2S0OdIaZ44D1j377pmOICIMtl9z1iqGsKAf5_kbIj53YcnMtX6N5P-CyJGQEgkcMfkUfHX6xZMZUfz8dNSg35mLzs-c7FzVS3GXAfJ0XCdw645WNz6NBgEcJFKm0UcoaWrcR-6V6q6ElMGLk7R1iBf4oR9ygxLhnSw61QdgYiO6yLO_RFI90f96enffgRsJqTfI0KSzwuOsaq5OlNR27jG0SHUT9Pg8CJ744tFYui8CQ8-og0sXExw7uO-NX7eNoqT-ZUFss7y8y8HiRiLupXPyxvt3x3UtEMOiihf27udaKO9Ek0ZgOMrr6tZtCn9k9ISuI7H-5Kk9oNlImuO9vBj0t0GcieR2_U5HjyCIJIE-2cqCcxbPEaQB3ZRrEY6mznulAqhRxY31Uz7bq3d1NqK1MeyquYaIb3QxFUX8UxHW3_Q8kPGmecYiWoy5t7BeT4TUgP53MnRaD9KIW_pk4mEvJ_7GcwvB5i10J_0bKC0KX_MzhIKT_4QqMCRjwhIq6dirg_x7qjDniXWt8fYbtlwMrn9b8L6s8_0gzVxo9eCgVjipRFwPZD-9rsdc3NBMgc-mghGq2pK0l_HP5YKVnguspZllxLIbmU4GKB6CO7GKMv4GvtOyuYb6O8bqyn4vCaQ0a2BqiBW95lWUh2jfPuX5vZDB03rQ5UeSAYtGek6Qr7UJatuuO6htEFayXpQkdDqFey4Rb9c08RJkp5oQfXfv4SWD2xypgl8tOtNbRK0j9KmJrmW9QMtFzdXFlenuPr8NmJWIsrHJDzTtBZwPd8tFpnTU38uvaJBk2vhmfp8Apn6NIP7RsuVs5xPnz_UQ7FESlWgPfBfNnDJUgBDdebmiRcgekL0QE-WSSbqZwR38yWzr1Uj-dGoYEK3QSzGKQWvua7BYh0qRx8KaQGGVP0R8eG3QxPoyNjk_QL6xEw7CxY4LPCX-GTBQvWtcZ0jXlQwRwTv1OClnRFikEaBle-S0Eh42DJTLM-Cbcakg9eV8in6VlByT7fC0Fi189iL2VrZr-BXLtJ-QDTVwIJz_1OOCW5ioSAM9K3ISg9dNN-bmQm18x5Ul5xlkEGLTUJICgIUm3JnIkydr6SMfoQz9ErNNLdAmYa636n56pSVx881CYtvI11ItYKA4vDibdk7VNXlGrS7nQ0wb-WujjzlcvE7WzzOMm4cp97y8bBs4wLHlncVis1kTjvrrIcNbN4S7Iv9mjbOfVGJKKgPkabzVbzrdnY22v0ExBXZoDi_jLOvVCMmPmZby8J8KboX7HCfeJyK12acCAsNH0CHywjFoIFszyCkLxIvYHBdsM_NCyCEFwgwbC5qERBLtdcm-Y0yOmmD44sraJWVtScqlkJv5LqGisSORb4F8suLXIa4ZnmKvdlyZdNzFIED6RoTX8hKy6K_FzyvQOlDDZB195lJoNKcDRNPsNRqJ037-yOHup57Awago7pXik5JwAjvyb0URoLvUq7Q3r4xGowk0mz5Ek18JujrzvqVc_d0ydAmjxwbfcJi5rbp7yahNWwAD4TUcwRShq1izNrK33k8hSlle4XEx7g8xAP7f528JXB3GcG8BhjxF5dixQbYxH442LdRFDyc3wkQDPmbn2Xcm5PO2FrYWEyVHjJ2sqmvoDkiUxRGLwxthuoS102KaTlwjx18mZ8CZ-cfr1RxDDNxlQUENRA5pPQeje0N5O1WHF4I6qLFYsO58xX1xpi9GKdrHkyIB5La1rQM1AhRwYKb3SMjNGLB9vIyI5mtcE6uI4UaFwS7jgKJuThLPpO8DK9GOQsdS4uI6M3ShcXYDuNX6Ofl5Md3ethC6_X9jwd-EwP3haSLsFkAAmehxUTua5zjbSin88DOLjmu5hrgHFeauOyq6p3DSeo8KBy1NgqIPcnDZfV17Nzqgg2UIE_sAgtowJP0cL-Ql5C7DGj; mod_auth_openidc_session_1=qMLs3UmWLvBp_fZ-eNWlZpnpZ8J5XAuniFMargGAaSzsHR_-OVYFzLGFOieUjxcZ64h5b0rCni_qFcpSLsAm3W96jlqmFu3KlYFW780xnMUp4JjWTFuFw-Bg6NOR6btOFnzPFYB0Qs0XZnhbp9DVkKYK91_e8JUDwuGCvptjbiTpw8z9peGqd3jw8rljLfCitza7xHdLzGwSM35TFKLPoj4awKIFVNXB4W-3DXBx3dlSc9nLSNc3-OaEtB-6Aauk5hYk86bNiyliRDhbme9x10codjb7DMSbT5eR8kXblgpbXUCRk1ZldvQ4YT-0vVM8eUWvV5zC15cMll9aU_WQGiWyIqV8gSW29zNKoDQmHpAgciAV6rymZoBBojDsBaynlbfiBuekStdDwvVBGo7z9z9_d1lFwgL8EJPvq8I_wSQP2e352T4TasWcAxdiu53DqfFyAy_MtoueXY5ZbWjRikJ01ItZXoQGevZXEMzDscObEAnCFg6xIH-lFBOXKtpX5RKnv2BFTf3uVWq12_h0ezWLPEZ7uBpGv6irQjel-KCr1v6cLsLy-lQwam3rdKO5wtsb7cntkQnEU4prrbLShgMFMdzq0j_1y0AW3rnyuEtxG6rKKTkSB2U-ZvQqoANrSoS0murb9QEbj5tZ2XNOFkTX3P.qp_ewWWGTjz_Mdfjlga7kw; mod_auth_openidc_session_chunks=2


Using mod_auth_oidc OIDCInfoHook, get the decrypted session info:
{
  "session": {
    "state": {
      "idc": "{\"exp\":1702880192,\"iat\":1702879892,\"auth_time\":1702879892,\"jti\":\"8ef9753d-697d-4dc6-9819-840fe5e99a9b\",\"iss\":\"http://localhost:8443/realms/moonspeak\",\"aud\":\"moonbasic\",\"sub\":\"42370f1a-8581-4d1e-b1d0-b5d467162031\",\"typ\":\"ID\",\"azp\":\"moonbasic\",\"nonce\":\"x9xdKTHS3lUsQAKhyd1nYrPYWjydPqcuH8PNwAsgKRY\",\"session_state\":\"0236627f-ef8a-4c62-bc1e-2eac25d1ff53\",\"at_hash\":\"DC5YrE7N9ImvZOQxQYzZGw\",\"sid\":\"0236627f-ef8a-4c62-bc1e-2eac25d1ff53\"}",
      "iss": "http://localhost:8443/realms/moonspeak",
      "rs": "q87qk1Hv2YYy1sp6hdNH88bq2vw",
      "ou": "http://localhost:8041/",
      "ss": "0236627f-ef8a-4c62-bc1e-2eac25d1ff53",
      "uic": "{\"sub\":\"42370f1a-8581-4d1e-b1d0-b5d467162031\"}",
      "at": "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJ5THVvYWhhRXJMcExoUHRVZzZpcUxpVnRkMWpIU2N3WXd5R0hlanBZRVBvIn0.eyJleHAiOjE3MDI4ODAxOTIsImlhdCI6MTcwMjg3OTg5MiwiYXV0aF90aW1lIjoxNzAyODc5ODkyLCJqdGkiOiIxMWVlNjlhYy03OWMwLTQzOTQtOGVjMi05MTNkMTQxNjVhY2EiLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0Ojg0NDMvcmVhbG1zL21vb25zcGVhayIsInN1YiI6IjQyMzcwZjFhLTg1ODEtNGQxZS1iMWQwLWI1ZDQ2NzE2MjAzMSIsInR5cCI6IkJlYXJlciIsImF6cCI6Im1vb25iYXNpYyIsIm5vbmNlIjoieDl4ZEtUSFMzbFVzUUFLaHlkMW5ZclBZV2p5ZFBxY3VIOFBOd0FzZ0tSWSIsInNlc3Npb25fc3RhdGUiOiIwMjM2NjI3Zi1lZjhhLTRjNjItYmMxZS0yZWFjMjVkMWZmNTMiLCJzY29wZSI6Im9wZW5pZCIsInNpZCI6IjAyMzY2MjdmLWVmOGEtNGM2Mi1iYzFlLTJlYWMyNWQxZmY1MyJ9.KFAYVEh-Gbb32pP9nW3JQnoTk46Wkh42jrypT234dgVaiEso0XYDy6LhQE63H1lkOk7MYSmCfJNUnS2n-fvmN93se0O9kPhITDKPTAuAgljI5AUv06LTpdEpwdQBw0uc4lI4F8XQrVxiGscWlhRPG1tQFmejW-QYGgRYs8XJHGZiifO-pl4SZIeDCx-gWdEWXSjv8yDRYWf-pe2H06WLsRIq3_ug2Q-awgItvum_vy3d4BkpIrgTM67UxdmJ2SeY1GLPsTer1qAS6F53UtzJRukJIG56jZnbsMJxVfh5a08MYcHbu83n2jIQojngfRdYWr2VB5CWi962PPxJH6bZGA",
      "ate": "1702880192",
      "atlr": "1702879892",
      "rt": "eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI2MmQzZWNlYS0yYzgwLTRlMTUtYTk4MC1mZjZkZDRiNTBjOWUifQ.eyJleHAiOjE3MDMwNTI2OTEsImlhdCI6MTcwMjg3OTg5MiwianRpIjoiNmIxYWUyNzctMTVmOS00YTdiLTk5MmQtYTE5ODNlODRkODZiIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4NDQzL3JlYWxtcy9tb29uc3BlYWsiLCJhdWQiOiJodHRwOi8vbG9jYWxob3N0Ojg0NDMvcmVhbG1zL21vb25zcGVhayIsInN1YiI6IjQyMzcwZjFhLTg1ODEtNGQxZS1iMWQwLWI1ZDQ2NzE2MjAzMSIsInR5cCI6IlJlZnJlc2giLCJhenAiOiJtb29uYmFzaWMiLCJub25jZSI6Ing5eGRLVEhTM2xVc1FBS2h5ZDFuWXJQWVdqeWRQcWN1SDhQTndBc2dLUlkiLCJzZXNzaW9uX3N0YXRlIjoiMDIzNjYyN2YtZWY4YS00YzYyLWJjMWUtMmVhYzI1ZDFmZjUzIiwic2NvcGUiOiJvcGVuaWQiLCJzaWQiOiIwMjM2NjI3Zi1lZjhhLTRjNjItYmMxZS0yZWFjMjVkMWZmNTMifQ.vgHAD3ugNiC4q01N91SnTCJ7JZJwODk4dzipTBbfjyk",
      "se": "1702908692",
      "cd": "localhost",
      "r": "42370f1a-8581-4d1e-b1d0-b5d467162031",
      "e": 1702883805
    }
  }
}
